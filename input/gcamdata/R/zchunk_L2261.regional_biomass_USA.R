#' module_gcamusa_L2261.regional_biomass_USA
#'
#' Create biomass supply sectors at the state level.
#'
#' @param command API command to execute
#' @param ... other optional parameters, depending on command
#' @return Depends on \code{command}: either a vector of required inputs,
#' a vector of output names, or (if \code{command} is "MAKE") all
#' the generated outputs: \code{L2261.DeleteSupplysector_bio_USA}, \code{L2261.Supplysector_bio_USA},
#' \code{L2261.SubsectorShrwtFllt_bio_USA}, \code{L2261.SubsectorInterp_bio_USA}, \code{L2261.SubsectorLogit_bio_USA},
#' \code{L2261.StubTech_bio_USA}, \code{L2261.StubTechMarket_bio_USA}, \code{L2261.StubTechShrwt_rbO_USA},
#' \code{L2261.StubTechFractSecOut_bio_USA}, \code{L2261.StubTechFractProd_bio_USA}, \code{L2261.DepRsrc_DDGS_USA},
#' \code{L2261.DepRsrcPrice_DDGS_USA}, \code{L2261.Tech_rbm_USA}, \code{L2261.TechShrwt_rbm_USA},
#' \code{L2261.TechCoef_rbm_USA}, \code{L2261.Tech_dbm_USA}, \code{L2261.TechShrwt_dbm_USA},
#' \code{L2261.TechEff_dbm_USA}, \code{L2261.TechCost_dbm_USA}, \code{L2261.CarbonCoef_bio_USA},
#' \code{L2261.StubTechMarket_en_USA}, \code{L2261.StubTechMarket_elecS_USA}, \code{L2261.StubTechMarket_ind_USA},
#' \code{L2261.StubTechMarket_cement_USA}, \code{L2261.StubTechMarket_bld_USA}.
#' The corresponding file in the original data system was \code{L2261.regional_biomass_USA.R} (gcam-usa level2).
#' @details Create biomass supply sectors at the state level, in order ensure that biomass carbon-tracking is
#' contained entirely within the consuming region (state).
#' @importFrom assertthat assert_that
#' @importFrom dplyr filter mutate select
#' @importFrom tidyr gather spread
#' @author MTB Aug 2018
module_gcamusa_L2261.regional_biomass_USA <- function(command, ...) {
  if(command == driver.DECLARE_INPUTS) {
    return(c(FILE = "energy/A21.sector",
             FILE = "energy/A26.sector",
             FILE = "gcam-usa/A28.sector",
             "L202.CarbonCoef",
             "L221.GlobalTechCoef_en",
             "L221.SubsectorInterp_en",
             "L221.StubTech_en",
             "L221.StubTechShrwt_bio",
             "L221.StubTechFractProd_en",
             "L221.StubTechFractSecOut_en",
             "L221.DepRsrc_en",
             "L221.DepRsrcPrice_en",
             "L226.SubsectorInterp_en",
             "L226.GlobalTechEff_en",
             "L226.GlobalTechCost_en",
             "L222.StubTechMarket_en_USA",
             "L2234.StubTechMarket_elecS_USA",
             "L232.StubTechMarket_ind_USA",
             "L2321.StubTechMarket_cement_USA",
             "L244.StubTechMarket_bld"))
  } else if(command == driver.DECLARE_OUTPUTS) {
    return(c("L2261.DeleteSupplysector_bio_USA",
             "L2261.Supplysector_bio_USA",
             "L2261.SubsectorShrwtFllt_bio_USA",
             "L2261.SubsectorInterp_bio_USA",
             "L2261.SubsectorLogit_bio_USA",
             "L2261.StubTech_bio_USA",
             "L2261.StubTechMarket_bio_USA",
             "L2261.StubTechShrwt_rbO_USA",
             "L2261.StubTechFractSecOut_bio_USA",
             "L2261.StubTechFractProd_bio_USA",
             "L2261.DepRsrc_DDGS_USA",
             "L2261.DepRsrcPrice_DDGS_USA",
             "L2261.Tech_rbm_USA",
             "L2261.TechShrwt_rbm_USA",
             "L2261.TechCoef_rbm_USA",
             "L2261.Tech_dbm_USA",
             "L2261.TechShrwt_dbm_USA",
             "L2261.TechEff_dbm_USA",
             "L2261.TechCost_dbm_USA",
             "L2261.CarbonCoef_bio_USA",
             "L2261.StubTechMarket_en_USA",
             "L2261.StubTechMarket_elecS_USA",
             "L2261.StubTechMarket_ind_USA",
             "L2261.StubTechMarket_cement_USA",
             "L2261.StubTechMarket_bld_USA"))
  } else if(command == driver.MAKE) {

    all_data <- list(...)[[1]]

    # silence check package notes
    from.year <- input.cost <- input.unit <- logit.exponent <- logit.type <- market.name <-
      minicam.non.energy.input <- output.unit <- price.unit <- region <- sector.name <- state <-
      stub.technology <- subsector <- supplysector <- technology <- to.year <- year <- traded <-
      subsector.name <- share.weight <- fractional.secondary.output <- price <- fraction.produced <-
      PrimaryFuelCO2Coef.name <- PrimaryFuelCO2Coef <- minicam.energy.input <- NULL

    # Load required inputs
    A21.sector <- get_data(all_data, "energy/A21.sector")
    A26.sector <- get_data(all_data, "energy/A26.sector")
    A28.sector <- get_data(all_data, "gcam-usa/A28.sector")
    L202.CarbonCoef <- get_data(all_data, "L202.CarbonCoef")
    L221.GlobalTechCoef_en <- get_data(all_data, "L221.GlobalTechCoef_en")
    L221.SubsectorInterp_en <- get_data(all_data, "L221.SubsectorInterp_en")
    L221.StubTech_en <- get_data(all_data, "L221.StubTech_en")
    L221.StubTechShrwt_bio <- get_data(all_data, "L221.StubTechShrwt_bio")
    L221.StubTechFractProd_en <- get_data(all_data, "L221.StubTechFractProd_en")
    L221.StubTechFractSecOut_en <- get_data(all_data, "L221.StubTechFractSecOut_en")
    L221.DepRsrc_en <- get_data(all_data, "L221.DepRsrc_en")
    L221.DepRsrcPrice_en <- get_data(all_data, "L221.DepRsrcPrice_en")
    L226.SubsectorInterp_en <- get_data(all_data, "L226.SubsectorInterp_en")
    L226.GlobalTechEff_en <- get_data(all_data, "L226.GlobalTechEff_en")
    L226.GlobalTechCost_en <- get_data(all_data, "L226.GlobalTechCost_en")
    L222.StubTechMarket_en_USA <- get_data(all_data, "L222.StubTechMarket_en_USA")
    L2234.StubTechMarket_elecS_USA <- get_data(all_data, "L2234.StubTechMarket_elecS_USA")
    L232.StubTechMarket_ind_USA <- get_data(all_data, "L232.StubTechMarket_ind_USA")
    L2321.StubTechMarket_cement_USA <- get_data(all_data, "L2321.StubTechMarket_cement_USA")
    L244.StubTechMarket_bld <- get_data(all_data, "L244.StubTechMarket_bld")

    # ===================================================
    # Data Processing

    # Supply Sectors and Subsectors
    # Deleting USA-level biomass sectors
    # Not deleting USA regional biomass because gas processing & H2 central production
    # still both occur at the USA level and consume USA regional biomass
    A28.sector %>%
      filter(supplysector != "regional biomass") %>%
      mutate(region = gcam.USA_REGION) %>%
      select(region, supplysector) -> L2261.DeleteSupplysector_bio_USA

    # Supply sector information for state-level biomass sectors
    L2261.USA_biomass_sectors <- unique(A28.sector$supplysector)

    A21.sector %>%
      bind_rows(A26.sector) %>%
      filter(supplysector %in% L2261.USA_biomass_sectors) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      mutate(logit.year.fillout = min(MODEL_BASE_YEARS)) %>%
      select(LEVEL2_DATA_NAMES$Supplysector, logit.type) -> L2261.Supplysector_bio_USA

    # Subsector shareweights of state-level biomass sectors
    L2261.Supplysector_bio_USA %>%
      mutate(subsector = supplysector,
             year.fillout = min(MODEL_BASE_YEARS),
             share.weight = gcamusa.DEFAULT_SHAREWEIGHT) %>%
      select(LEVEL2_DATA_NAMES$SubsectorShrwtFllt) -> L2261.SubsectorShrwtFllt_bio_USA

    # Subsector shareweight interpolations for state-level biomass sectors
    L221.SubsectorInterp_en %>%
      bind_rows(L226.SubsectorInterp_en) %>%
      filter(region == gcam.USA_REGION) %>%
      # filter for biomass supply sectors
      semi_join(A28.sector, by = c("supplysector")) %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$SubsectorInterp) -> L2261.SubsectorInterp_bio_USA

    # NOTE: There is only one tech per subsector so the logit choice does not matter
    L2261.SubsectorShrwtFllt_bio_USA %>%
      select(LEVEL2_DATA_NAMES$Subsector) %>%
      mutate(logit.year.fillout = min(MODEL_BASE_YEARS),
             logit.exponent = gcamusa.DEFAULT_LOGITEXP,
             logit.type = gcamusa.DEFAULT_LOGIT_TYPE) -> L2261.SubsectorLogit_bio_USA


    # Stub-technologies for biomass sectors that consume from global markets
    # Stub-technologies for state-level biomass sector
    L221.StubTech_en %>%
      filter(region == gcam.USA_REGION) %>%
      # filter for biomass supply sectors
      semi_join(A28.sector, by = c("supplysector")) %>%
      # NOTE: can't use stub technology for state-level regional biomass sectors
      # because they would inherit the wrong energy-inputs
      filter(stub.technology != "regional biomass") %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$StubTech) -> L2261.StubTech_bio_USA

    # Technology inputs & markets of state-level biomass sectors
    L221.GlobalTechCoef_en %>%
      rename(supplysector = sector.name, subsector = subsector.name, stub.technology = technology) %>%
      semi_join(L2261.StubTech_bio_USA, by = c("supplysector", "subsector", "stub.technology")) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      mutate(market.name = gcam.USA_REGION) %>%
      select(LEVEL2_DATA_NAMES$StubTechMarket) -> L2261.StubTechMarket_bio_USA

    # Technology share-weights of state-level regional biomassOil sectors
    L221.StubTechShrwt_bio %>%
      filter(region == gcam.USA_REGION) %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$StubTechYr, share.weight) -> L2261.StubTechShrwt_rbO_USA

    # Secondary (feed) outputs of global technologies for upstream (bio)energy
    # NOTE: secondary outputs are only considered in future time periods
    # NOTE: secondary outputs are only written for the regions/technologies where applicable,
    # so the global tech database can not be used
    L221.StubTechFractSecOut_en %>%
      filter(region == gcam.USA_REGION) %>%
      # filter for biomass supply sectors
      semi_join(A28.sector, by = c("supplysector")) %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$StubTechFractSecOut) -> L2261.StubTechFractSecOut_bio_USA

    # Cost curve points for producing secondary output feedcrops
    L221.StubTechFractProd_en %>%
      filter(region == gcam.USA_REGION) %>%
      # filter for biomass supply sectors
      semi_join(A28.sector, by = c("supplysector")) %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$StubTechYr, fractional.secondary.output, price, fraction.produced) -> L2261.StubTechFractProd_bio_USA


    # Connecting state-level DDGS & feedcakes secondary outputs to USA sector
    # Depletable resource info for state-level DDGS & feedcake secondary outputs
    L221.DepRsrc_en %>%
      filter(region == gcam.USA_REGION) %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$DepRsrc) -> L2261.DepRsrc_DDGS_USA

    # Depletable resource prices for state-level DDGS & feedcake secondary outputs
    L221.DepRsrcPrice_en %>%
      filter(region == gcam.USA_REGION) %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$DepRsrcPrice) -> L2261.DepRsrcPrice_DDGS_USA


    # Technologies for state-level regional biomass sectors, which consume "regional biomass" from USA regional biomass sector
    # NOTE: can't use stub technology for state-level regional biomass sectors because they would inherit the wrong energy-inputs
    L221.StubTech_en %>%
      filter(region == gcam.USA_REGION,
             stub.technology == "regional biomass") %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      rename(technology = stub.technology) %>%
      select(LEVEL2_DATA_NAMES$Tech) -> L2261.Tech_rbm_USA

    # Technology shareweights of state-level regional biomass sectors
    L2261.Tech_rbm_USA %>%
      repeat_add_columns(tibble::tibble(year = MODEL_YEARS)) %>%
      mutate(share.weight = gcamusa.DEFAULT_SHAREWEIGHT) %>%
      select(LEVEL2_DATA_NAMES$TechYr, share.weight) -> L2261.TechShrwt_rbm_USA

    # Technology input & efficiencies of state-level regional biomass sectors
    # State-level regional biomass sectors consume "regional biomass" from USA regional biomass sector
    # This is done to avoid any potential conflict with the bio trade feature
    L2261.TechShrwt_rbm_USA %>%
      select(LEVEL2_DATA_NAMES$TechYr) %>%
      mutate(minicam.energy.input = "regional biomass",
             coefficient = gcamusa.DEFAULT_COEFFICIENT,
             market.name = gcam.USA_REGION) %>%
      select(LEVEL2_DATA_NAMES$TechCoef) -> L2261.TechCoef_rbm_USA


    # Technologies for delivered biomass sectors, which consume from state-level markets
    # NOTE: can't use stub technology for delivered biomass sectors because they would inherit the wrong energy-inputs
    # Technologies for state-level delivered biomass sector
    L226.GlobalTechEff_en %>%
      # filter for biomass supply sectors
      semi_join(A28.sector, by = c("sector.name" = "supplysector")) %>%
      rename(supplysector = sector.name, subsector = subsector.name) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$Tech) %>%
      distinct() -> L2261.Tech_dbm_USA

    # Technology shareweights of state-level delivered biomass sectors
    L2261.Tech_dbm_USA %>%
      repeat_add_columns(tibble::tibble(year = MODEL_YEARS)) %>%
      mutate(share.weight = gcamusa.DEFAULT_SHAREWEIGHT) %>%
      select(LEVEL2_DATA_NAMES$TechYr, share.weight) -> L2261.TechShrwt_dbm_USA

    # Technology efficiencies of state-level delivered biomass sectors
    L226.GlobalTechEff_en %>%
      # filter for biomass supply sectors
      semi_join(A28.sector, by = c("sector.name" = "supplysector")) %>%
      rename(supplysector = sector.name, subsector = subsector.name) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      mutate(market.name = region) %>%
      select(LEVEL2_DATA_NAMES$TechEff) -> L2261.TechEff_dbm_USA

    # Technology costs for state-level delivered biomass sectors
    L226.GlobalTechCost_en %>%
      # filter for biomass supply sectors
      semi_join(A28.sector, by = c("sector.name" = "supplysector")) %>%
      rename(supplysector = sector.name, subsector = subsector.name)  %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(LEVEL2_DATA_NAMES$TechCost) -> L2261.TechCost_dbm_USA


    # Carbon coefficients for state-level biomass sectors
    L202.CarbonCoef %>%
      filter(region == gcam.USA_REGION,
             PrimaryFuelCO2Coef.name %in% c(L2261.USA_biomass_sectors)) %>%
      select(-region) %>%
      repeat_add_columns(tibble::tibble(region = gcamusa.STATES)) %>%
      select(region, PrimaryFuelCO2Coef.name, PrimaryFuelCO2Coef) -> L2261.CarbonCoef_bio_USA

    # Adjusting the carbon coefficient for USA regional biomass
    # This is necessary because, in order to ensure compatibility with the
    # bio trade and negative emissions budget features, US states can't consume biomass
    # from the global market, but rather consume regional biomass from the USA market.
    # In order to associate the sequestered carbon embedded in biomass feedstocks with
    # the state in which they're consumed (rather than the USA region), we set the
    # USA regional biomass carbon coefficient to zero
    L202.CarbonCoef %>%
      filter(region == gcam.USA_REGION,
             PrimaryFuelCO2Coef.name == "regional biomass") %>%
      mutate(PrimaryFuelCO2Coef = 0) %>%
      select(region, PrimaryFuelCO2Coef.name, PrimaryFuelCO2Coef) -> L2261.CarbonCoef_rbm_USA

    L2261.CarbonCoef_rbm_USA %>%
      bind_rows(L2261.CarbonCoef_bio_USA) -> L2261.CarbonCoef_bio_USA


    # Update minicam-energy-inputs for technologies that consume biomass
    set_state_biomass_markets <- function( data ){
      data_new <- data %>%
        filter(region %in% gcamusa.STATES,
               minicam.energy.input %in% L2261.USA_biomass_sectors) %>%
        mutate(market.name  = region)
      return( data_new)
    }

    # Energy Transformation (Refining)
    L2261.StubTechMarket_en_USA <- set_state_biomass_markets(L222.StubTechMarket_en_USA)

    # Electricity (load segments)
    L2261.StubTechMarket_elecS_USA <- set_state_biomass_markets(L2234.StubTechMarket_elecS_USA)

    # Industry
    L2261.StubTechMarket_ind_USA <- set_state_biomass_markets(L232.StubTechMarket_ind_USA)

    # Cement
    L2261.StubTechMarket_cement_USA <- set_state_biomass_markets(L2321.StubTechMarket_cement_USA)

    # Buildings
    L2261.StubTechMarket_bld_USA <- set_state_biomass_markets(L244.StubTechMarket_bld)


    # ===================================================
    # Produce outputs

    L2261.DeleteSupplysector_bio_USA %>%
      add_title("Delete USA-level Biomass Sectors") %>%
      add_units("NA") %>%
      add_comments("USA regional biomass not deleted") %>%
      add_comments("USA gas processing & H2 central production sectors still consume USA regional biomass") %>%
      add_legacy_name("L2261.DeleteSupplysector_bio_USA") %>%
      add_precursors("gcam-usa/A28.sector") ->
      L2261.DeleteSupplysector_bio_USA

    L2261.Supplysector_bio_USA %>%
      add_title("State-level Biomass Supply Sector Information") %>%
      add_units("unitless") %>%
      add_comments("Supply sector information for state-level biomass supply sectors") %>%
      add_legacy_name("L2261.Supplysector_bio_USA") %>%
      add_precursors("energy/A21.sector",
                     "energy/A26.sector",
                     "gcam-usa/A28.sector") ->
      L2261.Supplysector_bio_USA

    L2261.SubsectorShrwtFllt_bio_USA %>%
      add_title("Subsector Shareweights for State-level Biomass Supply Sectors") %>%
      add_units("unitless") %>%
      add_comments("Subsector shareweights for state-level biomass supply sectors") %>%
      add_legacy_name("L2261.SubsectorShrwtFllt_bio_USA") %>%
      same_precursors_as("L2261.Supplysector_bio_USA") ->
      L2261.SubsectorShrwtFllt_bio_USA

    L2261.SubsectorInterp_bio_USA %>%
      add_title("Subsector Shareweights for State-level Biomass Supply Sectors") %>%
      add_units("NA") %>%
      add_comments("Subsector shareweight interpolations for state-level biomass supply sectors") %>%
      add_legacy_name("L2261.SubsectorInterp_bio_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L221.SubsectorInterp_en",
                     "L226.SubsectorInterp_en") ->
      L2261.SubsectorInterp_bio_USA

    L2261.SubsectorLogit_bio_USA %>%
      add_title("Subsector Logits for State-level Biomass Supply Sectors") %>%
      add_units("unitless") %>%
      add_comments("Subsector logits for state-level biomass supply sectors") %>%
      add_comments("There is only one tech per subsector so the logit choice does not matter") %>%
      add_legacy_name("L2261.SubsectorLogit_bio_USA") %>%
      same_precursors_as("L2261.Supplysector_bio_USA") ->
      L2261.SubsectorLogit_bio_USA

    L2261.StubTech_bio_USA %>%
      add_title("State-level Biomass Supply Sector Stub Technologies") %>%
      add_units("NA") %>%
      add_comments("Stub-technologies for state-level biomass supply sectors") %>%
      add_legacy_name("L2261.StubTech_bio_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L221.StubTech_en") ->
      L2261.StubTech_bio_USA

    L2261.StubTechMarket_bio_USA %>%
      add_title("Technology Market Information for State-level Biomass Supply Sectors") %>%
      add_units("NA") %>%
      add_comments("Technology inputs and markets for state-level biomass supply sectors") %>%
      add_legacy_name("L2261.StubTechMarket_bio_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L221.GlobalTechCoef_en",
                     "L221.StubTech_en") ->
      L2261.StubTechMarket_bio_USA

    L2261.StubTechShrwt_rbO_USA %>%
      add_title("Technology Shareweights for State-level Regional Biomass Oil Supply Sectors") %>%
      add_units("unitless") %>%
      add_comments("Technology share-weights for state-level regional biomassOil supply sectors") %>%
      add_legacy_name("L2261.StubTechShrwt_rbO_USA") %>%
      add_precursors("L221.StubTechShrwt_bio") ->
      L2261.StubTechShrwt_rbO_USA

    L2261.StubTechFractSecOut_bio_USA %>%
      add_title("Secondary Feed Outputs of State-level Biomass Supply Sectors") %>%
      add_units("fractions") %>%
      add_comments("Secondary output (DDGS and feedcakes) generated from corn and biomassOil only") %>%
      add_comments("Secondary outputs are only considered in future time periods") %>%
      add_legacy_name("L2261.StubTechFractSecOut_bio_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L221.StubTechFractSecOut_en") ->
      L2261.StubTechFractSecOut_bio_USA

    L2261.StubTechFractProd_bio_USA %>%
      add_title("Production Information for State-level Biomass Supply Sector Secondary Feed Outputs") %>%
      add_units("1975$ (price); fraction") %>%
      add_comments("Cost curve points (prices and production fraction) for producing secondary output feedcrops") %>%
      add_comments("Secondary output (DDGS and feedcakes) generated from corn and biomassOil only") %>%
      add_legacy_name("L2261.StubTechFractProd_bio_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L221.StubTechFractProd_en") ->
      L2261.StubTechFractProd_bio_USA

    L2261.DepRsrc_DDGS_USA %>%
      add_title("Depletable Resource Information for State-level Biomass Supply Sector Secondary Feed Outputs") %>%
      add_units("NA") %>%
      add_comments("Depletable resource info for state-level DDGS & feedcake secondary outputs") %>%
      add_legacy_name("L2261.DepRsrc_DDGS_USA") %>%
      add_precursors("L221.DepRsrc_en") ->
      L2261.DepRsrc_DDGS_USA

    L2261.DepRsrcPrice_DDGS_USA %>%
      add_title("Depletable Resource Information for State-level Biomass Supply Sector Secondary Feed Outputs") %>%
      add_units("1975$/kg") %>%
      add_comments("Depletable resource prices for state-level DDGS & feedcake secondary outputs") %>%
      add_legacy_name("L2261.DepRsrcPrice_DDGS_USA") %>%
      add_precursors("L221.DepRsrcPrice_en") ->
      L2261.DepRsrcPrice_DDGS_USA

    L2261.Tech_rbm_USA %>%
      add_title("State-level Regional Biomass Technologies") %>%
      add_units("NA") %>%
      add_comments("Technologies for state-level regional biomass sector") %>%
      add_comments("Can't use stub-technology tag for regional biomass sectors because they would inherit the wrong energy-inputs") %>%
      add_precursors("L221.StubTech_en") ->
    L2261.Tech_rbm_USA

    L2261.TechShrwt_rbm_USA%>%
      add_title("Technology Shareweights for State-level Regional Biomass Sectors") %>%
      add_units("unitless") %>%
      add_comments("Technology shareweights for state-level regional biomass sectors") %>%
      same_precursors_as("L2261.Tech_rbm_USA") ->
    L2261.TechShrwt_rbm_USA

    L2261.TechCoef_rbm_USA%>%
      add_title("Technology Market Info for State-level Regional Biomass Sectors") %>%
      add_units("unitless") %>%
      add_comments("Technology market info and coefficients for state-level regional biomass sectors") %>%
      same_precursors_as("L2261.Tech_rbm_USA") ->
    L2261.TechCoef_rbm_USA

    L2261.Tech_dbm_USA %>%
      add_title("State-level Delivered Biomass Technologies") %>%
      add_units("NA") %>%
      add_comments("Technologies for state-level delivered biomass sector") %>%
      add_comments("Can't use stub-technology tag for delivered biomass sectors because they would inherit the wrong energy-inputs") %>%
      add_legacy_name("L2261.Tech_dbm_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L226.GlobalTechEff_en") ->
      L2261.Tech_dbm_USA

    L2261.TechShrwt_dbm_USA %>%
      add_title("Technology Shareweights for State-level Delivered Biomass Sectors") %>%
      add_units("unitless") %>%
      add_comments("Technology shareweights for state-level delivered biomass sectors") %>%
      add_legacy_name("L2261.TechShrwt_dbm_USA") %>%
      same_precursors_as("L2261.Tech_dbm_USA") ->
      L2261.TechShrwt_dbm_USA

    L2261.TechEff_dbm_USA %>%
      add_title("Technology Efficiencies for State-level Delivered Biomass Sectors") %>%
      add_units("unitless") %>%
      add_comments("Technology efficiencies for state-level delivered biomass sectors") %>%
      add_legacy_name("L2261.TechEff_dbm_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L226.GlobalTechEff_en") ->
      L2261.TechEff_dbm_USA

    L2261.TechCost_dbm_USA %>%
      add_title("Technology Costs for State-level Delivered Biomass Sectors") %>%
      add_units("1975$/GJ") %>%
      add_comments("Technology costs for state-level delivered biomass sectors") %>%
      add_legacy_name("L2261.TechCost_dbm_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L226.GlobalTechCost_en") ->
      L2261.TechCost_dbm_USA

    L2261.CarbonCoef_bio_USA %>%
      add_title("Primary Energy CO2 Coefficient") %>%
      add_units("kgC/GJ") %>%
      add_comments("Carbon coefficients for state-level biomass sectors") %>%
      add_legacy_name("L2261.CarbonCoef_bio_USA") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L202.CarbonCoef") ->
      L2261.CarbonCoef_bio_USA

    L2261.StubTechMarket_en_USA %>%
      add_title("Market Information for State-level Refining Sectors") %>%
      add_units("NA") %>%
      add_comments("Updating market information for biomass inputs to state-level refining sectors") %>%
      add_comments("Now consuming from state-level biomass supply sectors") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L222.StubTechMarket_en_USA") ->
      L2261.StubTechMarket_en_USA

    L2261.StubTechMarket_elecS_USA %>%
      add_title("Market Information for State-level (multiple load segment) Electricity Sectors") %>%
      add_units("NA") %>%
      add_comments("Updating market information for biomass inputs to state-level electricity sectors") %>%
      add_comments("Now consuming from state-level biomass supply sectors") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L2234.StubTechMarket_elecS_USA") ->
      L2261.StubTechMarket_elecS_USA

    L2261.StubTechMarket_ind_USA %>%
      add_title("Market Information for State-level Industrial Energy Use Sectors") %>%
      add_units("NA") %>%
      add_comments("Updating market information for biomass inputs to state-level industrial energy use sectors") %>%
      add_comments("Now consuming from state-level biomass supply sectors") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L232.StubTechMarket_ind_USA") ->
      L2261.StubTechMarket_ind_USA

    L2261.StubTechMarket_cement_USA %>%
      add_title("Market Information for State-level Process Heat Cement Sectors") %>%
      add_units("NA") %>%
      add_comments("Updating market information for biomass inputs to state-level process heat cement sectors") %>%
      add_comments("Now consuming from state-level biomass supply sectors") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L2321.StubTechMarket_cement_USA") ->
      L2261.StubTechMarket_cement_USA

    L2261.StubTechMarket_bld_USA %>%
      add_title("Market Information for State-level Building Sectors") %>%
      add_units("NA") %>%
      add_comments("Updating market information for biomass inputs to state-level building sectors") %>%
      add_comments("Now consuming from state-level biomass supply sectors") %>%
      add_precursors("gcam-usa/A28.sector",
                     "L244.StubTechMarket_bld") ->
      L2261.StubTechMarket_bld_USA


    return_data(L2261.DeleteSupplysector_bio_USA,
                L2261.Supplysector_bio_USA,
                L2261.SubsectorShrwtFllt_bio_USA,
                L2261.SubsectorInterp_bio_USA,
                L2261.SubsectorLogit_bio_USA,
                L2261.StubTech_bio_USA,
                L2261.StubTechMarket_bio_USA,
                L2261.StubTechShrwt_rbO_USA,
                L2261.StubTechFractSecOut_bio_USA,
                L2261.StubTechFractProd_bio_USA,
                L2261.DepRsrc_DDGS_USA,
                L2261.DepRsrcPrice_DDGS_USA,
                L2261.Tech_rbm_USA,
                L2261.TechShrwt_rbm_USA,
                L2261.TechCoef_rbm_USA,
                L2261.Tech_dbm_USA,
                L2261.TechShrwt_dbm_USA,
                L2261.TechEff_dbm_USA,
                L2261.TechCost_dbm_USA,
                L2261.CarbonCoef_bio_USA,
                L2261.StubTechMarket_en_USA,
                L2261.StubTechMarket_elecS_USA,
                L2261.StubTechMarket_ind_USA,
                L2261.StubTechMarket_cement_USA,
                L2261.StubTechMarket_bld_USA)
  } else {
    stop("Unknown command")
  }
}
